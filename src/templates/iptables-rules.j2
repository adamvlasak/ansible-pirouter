#!/bin/bash
#
# Flush all current rules from iptables
#
iptables -t nat -F
iptables -t mangle -F
iptables -F
iptables -X
#
# Allow SSH connections on tcp port 22
# This is essential when working on remote servers via SSH to prevent locking yourself out of the system
#
iptables -A INPUT -s 192.168.1.0/24 -d 192.168.1.1/32 -i wlan0 -m conntrack --ctstate NEW -p tcp -m tcp --dport 22 -j ACCEPT
#
# Set default policies for INPUT, FORWARD and OUTPUT chains
#
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT DROP
#
# Prerouting
#
iptables -t mangle -A PREROUTING -m conntrack --ctstate INVALID -j DROP
iptables -t mangle -A PREROUTING -p tcp ! --syn -m conntrack --ctstate NEW -j DROP
iptables -t mangle -A PREROUTING -p tcp -m conntrack --ctstate NEW -m tcpmss ! --mss 536:65535 -j DROP
#
# Bogus TCP flags
#
iptables -t mangle -A PREROUTING -p tcp --tcp-flags FIN,SYN,RST,PSH,ACK,URG NONE -j DROP
iptables -t mangle -A PREROUTING -p tcp --tcp-flags FIN,SYN FIN,SYN -j DROP
iptables -t mangle -A PREROUTING -p tcp --tcp-flags SYN,RST SYN,RST -j DROP
iptables -t mangle -A PREROUTING -p tcp --tcp-flags FIN,RST FIN,RST -j DROP
iptables -t mangle -A PREROUTING -p tcp --tcp-flags FIN,ACK FIN -j DROP
iptables -t mangle -A PREROUTING -p tcp --tcp-flags ACK,URG URG -j DROP
iptables -t mangle -A PREROUTING -p tcp --tcp-flags ACK,FIN FIN -j DROP
iptables -t mangle -A PREROUTING -p tcp --tcp-flags ACK,PSH PSH -j DROP
iptables -t mangle -A PREROUTING -p tcp --tcp-flags ALL ALL -j DROP
iptables -t mangle -A PREROUTING -p tcp --tcp-flags ALL NONE -j DROP
iptables -t mangle -A PREROUTING -p tcp --tcp-flags ALL FIN,PSH,URG -j DROP
iptables -t mangle -A PREROUTING -p tcp --tcp-flags ALL SYN,FIN,PSH,URG -j DROP
iptables -t mangle -A PREROUTING -p tcp --tcp-flags ALL SYN,RST,ACK,FIN,URG -j DROP
#
# Spoofing
#
iptables -t mangle -A PREROUTING -s 224.0.0.0/3 -j DROP
iptables -t mangle -A PREROUTING -s 169.254.0.0/16 -j DROP
iptables -t mangle -A PREROUTING -s 172.16.0.0/12 -j DROP
iptables -t mangle -A PREROUTING -s 192.0.2.0/24 -j DROP
iptables -t mangle -A PREROUTING -s 10.0.0.0/8 -j DROP
iptables -t mangle -A PREROUTING -s 240.0.0.0/5 -j DROP
iptables -t mangle -A PREROUTING -s 127.0.0.0/8 ! -i lo -j DROP
#
# Force DNS
#
iptables -t nat -A PREROUTING ! -d 192.168.1.1/32 -p tcp --dport 53 -j DNAT --to 192.168.1.1
iptables -t nat -A PREROUTING ! -d 192.168.1.1/32 -p udp --dport 53 -j DNAT --to 192.168.1.1
#
# Ping
#
iptables -A INPUT -p icmp --icmp-type 8 -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT
iptables -A OUTPUT -p icmp --icmp-type 0 -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -A OUTPUT -p icmp --icmp-type 8 -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT
iptables -A INPUT -p icmp --icmp-type 0 -m state --state ESTABLISHED,RELATED -j ACCEPT
#
# Allowed input packets
#
iptables -A INPUT -i lo -j ACCEPT
iptables -A INPUT -s 192.168.1.0/24 -d 192.168.1.1/32 -i wlan0 -m conntrack --ctstate NEW -p udp -m udp --dport 53 -j ACCEPT
iptables -A INPUT -s 192.168.1.0/24 -d 192.168.1.1/32 -i wlan0 -m conntrack --ctstate NEW -p tcp -m tcp --dport 53 -j ACCEPT
iptables -A INPUT -s 192.168.1.0/24 -d 192.168.1.1/32 -i wlan0 -p tcp -m tcp -m conntrack --ctstate NEW --dport 80 -j ACCEPT
iptables -A INPUT -i wlan0 -p udp -m udp -m conntrack --ctstate NEW --sport 68 --dport 67 -j ACCEPT
iptables -A INPUT -i eth0 -p udp -m udp -m conntrack --ctstate NEW --sport 67 --dport 68 -j ACCEPT
iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
iptables -A INPUT -j LOG --log-prefix "INPUT DROP: "
iptables -A INPUT -f -j DROP
iptables -A INPUT -m tcp -p tcp -j REJECT --reject-with tcp-reset
iptables -A INPUT -m udp -p udp -j REJECT --reject-with icmp-port-unreachable
iptables -A INPUT -j REJECT --reject-with icmp-proto-unreachable
#
# Forward
#
iptables -A FORWARD -d 192.168.1.0/24 -i eth0 -o wlan0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
iptables -A FORWARD -s 192.168.1.0/24 -i wlan0 -o eth0 -m conntrack --ctstate NEW,ESTABLISHED -j ACCEPT
iptables -A FORWARD -j LOG --log-prefix "FORWARD DROP: "
iptables -A FORWARD -m tcp -p tcp -j REJECT --reject-with tcp-reset
iptables -A FORWARD -m udp -p udp -j REJECT --reject-with icmp-port-unreachable
iptables -A FORWARD -j REJECT --reject-with icmp-proto-unreachable
#
# Allowed output packets
#
iptables -A OUTPUT -s 127.0.0.1/32 -o lo -j ACCEPT
iptables -A OUTPUT -s 192.168.1.0/24 -o wlan0 -d 192.168.1.0/24 -j ACCEPT
iptables -A OUTPUT -s 192.168.0.0/24 -o eth0 -m conntrack --ctstate NEW -m tcp -p tcp --dport 80 -j ACCEPT
iptables -A OUTPUT -s 192.168.0.0/24 -o eth0 -m conntrack --ctstate NEW -m tcp -p tcp --dport 443 -j ACCEPT
iptables -A OUTPUT -s 192.168.0.0/24 -o eth0 -m conntrack --ctstate NEW -m udp -p udp --dport 443 -j ACCEPT
iptables -A OUTPUT -s 192.168.0.0/24 -o eth0 -m conntrack --ctstate NEW -m tcp -p tcp --dport 53 -j ACCEPT
iptables -A OUTPUT -s 192.168.0.0/24 -o eth0 -m conntrack --ctstate NEW -m udp -p udp --dport 53 -j ACCEPT
iptables -A OUTPUT -s 192.168.0.0/24 -o eth0 -m conntrack --ctstate NEW -m udp -p udp --dport 123 -j ACCEPT
iptables -A OUTPUT -o eth0 -m conntrack --ctstate NEW -m udp -p udp --sport 68 --dport 67 -j ACCEPT
iptables -A OUTPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -j LOG --log-prefix "OUTPUT DROP: "
iptables -A OUTPUT -m tcp -p tcp -j REJECT --reject-with tcp-reset
iptables -A OUTPUT -m udp -p udp -j REJECT --reject-with icmp-port-unreachable
iptables -A OUTPUT -j REJECT --reject-with icmp-proto-unreachable
#
# NAT
#
iptables -A POSTROUTING -t nat -o eth0 -j MASQUERADE
#
# Disallow IPV6
#
ip6tables -P INPUT DROP
ip6tables -P FORWARD DROP
ip6tables -P OUTPUT DROP