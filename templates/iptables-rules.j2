#!/bin/bash
#
# Flush all current rules from iptables
#
iptables -F
#
# Allow SSH connections on tcp port 22
# This is essential when working on remote servers via SSH to prevent locking yourself out of the system
#
iptables -A INPUT -s 192.168.1.0/24 -d 192.168.1.1/32 -i wlan0 -m conntrack --ctstate NEW -p tcp -m tcp --dport 22 -j ACCEPT
#
# Set default policies for INPUT, FORWARD and OUTPUT chains
#
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT DROP
#
iptables -A INPUT -m conntrack --ctstate INVALID -j DROP
#
# Set access for localhost
#
iptables -A INPUT -i lo -j ACCEPT
iptables -A OUTPUT -s 127.0.0.1/32 -o lo -j ACCEPT
#
# ICMP from inside to outside
iptables -A OUTPUT -p icmp --icmp-type echo-request -j ACCEPT
iptables -A INPUT -p icmp --icmp-type echo-reply -j ACCEPT
#
# Allowed input packets
#
iptables -A INPUT -s 192.168.1.0/24 -d 192.168.1.1/32 -i wlan0 -m conntrack --ctstate NEW -p udp -m udp --dport 53 -j ACCEPT
iptables -A INPUT -i wlan0 -p udp -m udp -m conntrack --ctstate NEW --dport 67 -j ACCEPT
iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
iptables -A INPUT -j LOG --log-prefix "INPUT DROP:" --log-level 6
iptables -A INPUT -j DROP
#
# Forward
#
iptables -A FORWARD -d 192.168.1.0/24 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
iptables -A FORWARD -s 192.168.1.0/24 -i wlan0 -o eth0 -j ACCEPT
#
# Allowed output packets
#
iptables -A OUTPUT -s 192.168.1.0/24 -o wlan0 -d 192.168.1.0/24 -j ACCEPT
iptables -A OUTPUT -s 192.168.0.0/24 -o eth0 -p tcp --dport 80 -j ACCEPT
iptables -A OUTPUT -s 192.168.0.0/24 -o eth0 -p tcp --dport 443 -j ACCEPT
iptables -A OUTPUT -s 192.168.0.0/24 -o eth0 -m conntrack --ctstate NEW -p udp --dport 53 -j ACCEPT
iptables -A OUTPUT -s 192.168.0.0/24 -o eth0 -m conntrack --ctstate NEW -p udp --dport 123 -j ACCEPT
iptables -A OUTPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
iptables -A OUTPUT -j LOG --log-prefix "OUTPUT DROP:" --log-level 6
iptables -A OUTPUT -m conntrack --ctstate INVALID -j DROP
iptables -A OUTPUT -j DROP
#
# NAT
#
iptables -A POSTROUTING -t nat -o eth0 -j MASQUERADE
#
# Disallow IPV6
#
ip6tables -P INPUT DROP
ip6tables -P FORWARD DROP
ip6tables -P OUTPUT DROP
